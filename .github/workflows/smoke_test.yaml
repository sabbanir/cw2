
# Run smoke tests on Merge Requests
image: python:3.11-slim

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_CACHE_DIR: "off"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Ensure our package (src/) is importable if editable install is skipped
  PYTHONPATH: "$CI_PROJECT_DIR:$PYTHONPATH"
  # Make test output and coverage machine-readable
  PYTEST_ADDOPTS: "-q --maxfail=1 --disable-warnings --color=yes --junitxml=reports/junit.xml"

cache:
  key: "pip-${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip
    - .venv/

stages:
  - lint
  - test

# ---------- Pre-install script used by multiple jobs ----------
.before_install: &before_install
  - python -V
  - pip -V
  - python -m pip install --upgrade pip wheel setuptools
  # Prefer Poetry if pyproject.toml specifies it
  - |
    if [ -f pyproject.toml ] && grep -qi "\[tool.poetry\]" pyproject.toml; then
      python -m pip install poetry
      poetry config virtualenvs.in-project true
      poetry install --no-interaction --no-ansi
    # Else fall back to pip with requirements.txt or editable install
    elif [ -f requirements.txt ]; then
      pip install -r requirements.txt
      # If you have a setup.py/pyproject (PEP 517) to expose 'src' as a package:
      if [ -f setup.py ] || [ -f pyproject.toml ]; then
        pip install -e .
      fi
    else
      # Minimal deps often used in your repo; add/remove as needed
      pip install pytest pytest-cov ruff flake8
      # Try editable install to expose src/ if setup.py/pyproject exists
      if [ -f setup.py ] || [ -f pyproject.toml ]; then
        pip install -e .
      fi
    fi

# ---------- Lint Job (optional) ----------
lint:
  stage: lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "src/**/*"
        - "tests/**/*"
        - "pyproject.toml"
        - "requirements.txt"
        - "setup.py"
        - ".gitlab-ci.yml"
  script:
    # Prefer Ruff if present; fall back to flake8
    - |
      if python -c "import importlib; import sys; sys.exit(0) if importlib.util.find_spec('ruff') else sys.exit(1)"; then
        echo "Running Ruff…"
        ruff check src tests || true   # non-blocking; change to `|| exit 1` to enforce
      elif python -c "import importlib; import sys; sys.exit(0) if importlib.util.find_spec('flake8') else sys.exit(1)"; then
        echo "Running Flake8…"
        flake8 src tests || true       # non-blocking; change to `|| exit 1` to enforce
      else
        echo "No linter installed; skipping."
      fi
  before_script:
    - *before_install
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - .ruff_cache/
      - .flake8
    reports: {}

# ---------- Test Job (runs your smoke test on MR) ----------
test:mr_smoke:
  stage: test
  needs: ["lint"]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "src/**/*"
        - "tests/**/*"
        - "evaluate/**/*"
        - "pyproject.toml"
        - "requirements.txt"
        - "setup.py"
        - ".gitlab-ci.yml"
        - "test_smoke_wine_quality.py"
  before_script:
    - *before_install
  script:
    # Ensure src is importable if no packaging exists
    - python -c "import sys, os; sys.path.insert(0, os.getcwd()); import src, pathlib; print('src import OK')"
    # Run pytest — target the smoke test file to keep MR fast
    - |
      if [ -f test_smoke_wine_quality.py ]; then
        pytest -q --cov=src --cov-report=xml:test-reports/coverage.xml test_smoke_wine_quality.py
      elif [ -d tests ]; then
        pytest -q --cov=src --cov-report=xml:test-reports/coverage.xml -k 'smoke or tiny'
      else
        echo "No tests found"; exit 1
      fi
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - reports/
      - test-reports/
      - .coverage
    reports:
      junit: reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: test-reports/coverage.xml
